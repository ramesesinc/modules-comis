import com.rameses.annotations.*;
import com.rameses.common.*;
import com.rameses.services.extended.*;

class ComisCemeteryInterceptor {
	@DataContext('resource')
	def em_resource;

	@DataContext('cemetery_section')
	def em_section;

	@DataContext('cemetery_section_resource')
	def em_section_resource;

	@DataContext('cemetery_section_resource_info')
	def em_section_resource_info;

	@Before(pattern="PersistenceService.removeEntity", eval="#{ args[0]._schemaname == 'cemetery' }")
	public void beforeDeleteCemetery(def evt) {
		def cemetery = evt.args[0];
		def sections = em_section.find([parentid: cemetery.objid]).list();
		println 'sections => ' + sections;
		sections.each{section ->
			deleteSectionResources(section);
			em_section.find([objid: section.objid]).delete();
		}
	}	

	@After(pattern="PersistenceService.create", eval="#{ args[0]._schemaname == 'cemetery_section_resource' }")
	public void afterCreateResource(def evt) {
		def resource = evt.result;
		def info = [:]
		info.putAll(resource);
		info.parentid = resource.objid;
		info.state = 'DRAFT';
		info = em_section_resource_info.create(info);
		em_section_resource.find([objid: resource.objid]).update([currentinfoid: info.objid]);
	}	

	@After(pattern="PersistenceService.update", eval="#{ args[0]._schemaname == 'cemetery_section_resource' }")
	public void afterUpdateResource(def evt) {
		def resource = evt.result;
		def info = [:]
		info.putAll(resource);
		info.objid = resource.currentinfoid;
		info.parentid = resource.objid;
		info._schemaname = 'cemetery_section_resource_info';
		info = em_section_resource_info.update(info);
	}	

	@After(pattern="PersistenceService.read", eval="#{ args[0]._schemaname == 'cemetery_section_resource' }")
	public void afterOpenResource(def evt) {
		def entity = evt.result;
		def info = em_section_resource_info.find([objid: entity.currentinfoid]).first();
		entity.resource = em_resource.find([objid: info.resource.objid]).first();
	}	

	@Before(pattern="PersistenceService.removeEntity", eval="#{ args[0]._schemaname == 'cemetery_section' }")
	public void beforeDeleteSection(def evt) {
		def section = evt.args[0];
		deleteSectionResources(section);
	}	

	@Before(pattern="PersistenceService.removeEntity", eval="#{ args[0]._schemaname == 'cemetery_section_resource' }")
	public void beforeDeleteResource(def evt) {
		def resource = evt.args[0];
		em_section_resource.find([objid: resource.objid]).update([currentinfoid: null]);
		em_section_resource_info.find([parentid: resource.objid]).delete();
	}	


	void deleteSectionResources(section) {
		def resources = em_section_resource.find([parentid: section.objid]).list();
		resources.each {
			em_section_resource.find([objid: it.objid]).update([currentinfoid: null]);
			em_section_resource_info.find([parentid: it.objid]).delete();
			em_section_resource.find([objid: it.objid]).delete();
		}
	}
}